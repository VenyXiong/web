(window.MIP=window.MIP||[]).push({name:"mip-infinitescroll",func:function(){define("mip-infinitescroll/infinitescroll",["require","jquery","viewport"],function(t){var e=t("jquery"),o=t("viewport"),n=function(t){if(t.$result&&t.$loading&&t.pushResult){var o=this;t.$result=e(t.$result),t.$loading=e(t.$loading),o.options=e.extend({$wrapper:e(window),$scroller:e("body"),firstResult:[],scrollPageClass:"mip-infinitescroll-page",loadingHtml:"加载中...",loadFailHtml:"加载失败,点击重试",loadOverHtml:"加载完毕",bufferHeightPx:10,pageResultNum:10,limitShowPn:2,preLoadPn:1},t),o._init()}};return n.prototype={version:"0.1.0",_init:function(){var t=this;if(t.eventSpace=".InfiniteScroll",t.state="start",t.scrollPageCache={topPosition:[],content:[]},t.dataStatus=1,t.currentLoadPage=t.options.firstResult.length?0:-1,t.currentShowPage=0,t._horizontalHack(),t.options.$loading.html(t.options.loadingHtml),t.options.firstResult.length)t.scrollPageCache.content=t.scrollPageCache.content.concat(t._separatePage(t.options.firstResult)),t.options.$result.html(t._wrapPageParentDom(t.scrollPageCache.content[0],0)),t.scrollPageCache.topPosition.push(t.options.$result.position().top);if(t.refresh(),e(window).on("resize"+t.eventSpace,function(){t.refresh()}),t._bindScroll(),!t.options.firstResult.length)t._scrollBottomFn()},refresh:function(){var t=this;if("pause"!==t.state)t.wrapperHeight=t.options.$wrapper.height(),t.scrollerHeight=this._getScrollerHeight(),t.currentScrollTop=t.options.$wrapper.scrollTop()},destroy:function(){var t=this;e(window).off("resize"+t.eventSpace),t.options.$wrapper.off("scroll"+t.eventSpace),t.options.$loading.off("click"+t.eventSpace),o.off("scroll",t.scrollHandler),t.scrollPageCache=null},pause:function(){var t=this;if("pause"!==t.state)t.pauseScrollTop=t.currentScrollTop,t.state="pause"},start:function(){var t=this;if("start"!==t.state)t.options.$wrapper.scrollTop(t.pauseScrollTop),t.refresh(),t.state="start"},_horizontalHack:function(){var t,o=this;if(void 0!==window.orientation){if(0===window.orientation||180===window.orientation)t=Math.min(window.screen.width,e(window).width());else if(90===window.orientation||-90===window.orientation)t=Math.min(window.screen.width,window.screen.height),t=t*e(window).width()/Math.max(window.screen.width,window.screen.height)}else t=Math.min(window.screen.width,window.screen.height);o.options.$result.css({"max-width":t+"px"})},_bindScroll:function(){var t,e=this;if(o.on("scroll",function(){if("pause"!==e.state){if(e.currentScrollTop=o.getScrollTop(),e.wrapperHeight=o.getHeight(),e.currentScrollTop<=0)e.options.onScrollTop&&e.options.onScrollTop.call(e);if(e.currentScrollTop>=e.scrollerHeight-e.wrapperHeight-e.options.bufferHeightPx)e._scrollBottomFn(),e.options.onScrollBottom&&e.options.onScrollBottom.call(e);var t=e.getShowPage();if(e.currentShowPage!==t)if(e.options.onChangeShowPN&&e.options.onChangeShowPN.call(e,t,e.currentShowPage),e.currentShowPage=t,e.options.limitShowPn)e._cycleScrollElement(t)}}),e.currentScrollTop>=e.scrollerHeight-e.wrapperHeight-e.options.bufferHeightPx)o.trigger("scroll");this.scrollHandler=t},_scrollBottomFn:function(){var t=this,n=t.currentLoadPage+1,i=t.scrollPageCache.content.length-1;if(n<=i)t._updateScrollElement(n),t.options.onLoadNewPage&&t.options.onLoadNewPage.call(t,n);if(1===t.dataStatus&&n+t.options.preLoadPn>=i){var r=t.options.pushResult.call(t,(i+1)*t.options.pageResultNum,i-n);t.dataStatus=2,e.when(r).then(function(e){if(0==e||"NULL"===e)t.dataStatus=0,t.options.$loading.html(t.options.loadOverHtml);else if(e.length)t.dataStatus=1,t.scrollPageCache.content=t.scrollPageCache.content.concat(t._separatePage(e)),o.trigger("scroll")},function(){t.dataStatus=3,t.options.$loading.html(t.options.loadFailHtml).one("click"+t.eventSpace,function(){t.dataStatus=1,t.options.$loading.html(t.options.loadingHtml),o.trigger("scroll")})})}},_updateScrollElement:function(t){var o=this,n=e(o._wrapPageParentDom(o.scrollPageCache.content[t],t));o.options.$result.append(n),o.currentLoadPage=t,o.scrollerHeight=this._getScrollerHeight(),o.scrollPageCache.topPosition.push(n.position().top)},_getScrollerHeight:function(){return o.getScrollHeight()},_cycleScrollElement:function(t){var o=this,n="infinite-recycle",i=Math.max(t-Math.floor((o.options.limitShowPn-1)/2),0),r=o.options.$result.find("."+o.options.scrollPageClass),l=r.slice(i,i+o.options.limitShowPn);if(l.length)l.each(function(){if(e(this).hasClass(n))e(this).html(o.scrollPageCache.content[e(this).attr("data-page")]),e(this).removeClass(n)}),r.not(l).not("."+n).each(function(){e(this).height(e(this).height()).empty(),e(this).addClass(n)}),o.scrollerHeight=this._getScrollerHeight()},_separatePage:function(t){var e=this;if(t.length&&"NULL"!==t){for(var o=e.options.pageResultNum,n=Math.ceil(t.length/o),i=[],r=0;r<n;r++)i.push(t.slice(r*o,r*o+o).join(""));return i}},_wrapPageParentDom:function(t,e){return['<ul class="'+this.options.scrollPageClass+'" data-page="'+e+'">',t,"</ul>"].join("")},getShowPage:function(){for(var t=this,e=t.scrollPageCache.topPosition.concat(),o=e.length-1;o>=0;o--)if(t.currentScrollTop>=e[o])return o;return 0},constructor:n},n}),define("mip-infinitescroll/mip-infinitescroll",["require","util","templates","fetch-jsonp","customElement","./infinitescroll"],function(t){function e(t){var e=this,o=t;if(t.indexOf("?")>0)o+="?"===t[t.length-1]?"":"&",o+=e.params.pnName+"="+e.params.pn;else o+="?"+e.params.pnName+"="+e.params.pn;return o}var o=t("util"),n=t("templates"),i=t("fetch-jsonp"),r=t("customElement").create(),l=t("./infinitescroll"),a=null;return r.prototype.firstInviewCallback=function(){var t=this,r=t.element,s=r.getAttribute("data-src")||"";if(!s)return console.error("未填写src字段，不能获取数据"),void r.remove();t.params={rn:20,prn:6,pn:1,pnName:"pn",bufferHeightPx:10,loadingHtml:"加载中...",loadFailHtml:"加载失败",loadOverHtml:"加载完毕!",timeout:5e3};try{var c=r.querySelector('script[type="application/json"]');if(c)t.params=o.fn.extend(t.params,JSON.parse(c.textContent.toString())),t.params.rn="Infinity"===t.params.rn?1/0:t.params.rn}catch(t){return console.warn("json is illegal"),void console.warn(t)}t.url=e.call(t,s),t.pushResult=function(o,r){var l=$.Deferred();if(o>t.rn)l.resolve("NULL");else i(t.url,{jsonpCallback:"callback",timeout:t.params.timeout}).then(function(t){return t.json()}).then(function(i){if(i&&0===parseInt(i.status,10)&&i.data){if(o>t.params.rn||!i.data.items)l.resolve("NULL");n.render(t.element,i.data.items).then(function(t){l.resolve(t)}),t.params.pn++,t.url=e.call(t,s)}else l.resolve("NULL")},function(t){l.reject()});return l.promise()},a=new l({$result:r.querySelector(".mip-infinitescroll-results"),$loading:r.querySelector(".mip-infinitescroll-loading"),loadingHtml:t.params.loadingHtml,loadFailHtml:t.params.loadFailHtml,loadOverHtml:t.params.loadOverHtml,bufferHeightPx:t.params.bufferHeightPx,pageResultNum:t.params.prn,limitShowPn:0,preLoadPn:2,firstResult:[],pushResult:t.pushResult})},r.prototype.detachedCallback=function(){a=null},r}),define("mip-infinitescroll",["mip-infinitescroll/mip-infinitescroll"],function(t){return t}),function(){function t(t,e){t.registerMipElement("mip-infinitescroll",e)}if(window.MIP)require(["mip-infinitescroll"],function(e){t(window.MIP,e)});else require(["mip","mip-infinitescroll"],t)}()}});